{
    "variables": {
      "vm_name": "BuildVM",
      "cpu": "2",
      "ram_size": "2048",
      "disk_size": "153600",
      "disk_additional_size": "204800",
      "iso_checksum": "1948d088934b60529fefc3592dddb01175baf1f2",
	  "systemdrive": "{{env `SystemDrive`}}",
      "iso_url": "file://iso/Windows2016.iso",
      "iso_checksum_type": "sha1",
      "hyperv_switchname": "BlackJack Switch",

      "image_folder": "C:\\image",
      "commit_file": "C:\\image\\commit.txt",
      "metadata_file": "C:\\image\\metadata.txt",
      "helper_script_folder": "C:\\Program Files\\WindowsPowerShell\\Modules\\",
      "commit_id": "LATEST"
      "install_user" : "vagrant",
      "install_password" : "vagrant",
    },
    "builders": [
    {
      "vm_name":"{{user `vm_name`}}",
      "type": "hyperv-iso",
      "disk_size": "{{user `disk_size`}}",
      "disk_additional_size": "{{user `disk_additional_size`}}",
      "floppy_files": [],
      "secondary_iso_images": [
        "./Tools/answersISO/windows-2016-serverstandard-amd64/answer.iso"
      ],
      "http_directory": "./windows/common/http/",
      "boot_wait": "0s",
      "boot_command": [
        "a<enter><wait>a<enter><wait>a<enter><wait>a<enter>"
      ],
      "guest_additions_mode":"disable",
      "iso_url": "{{user `iso_url`}}",
      "iso_checksum_type": "{{user `iso_checksum_type`}}",
      "iso_checksum": "{{user `iso_checksum`}}",
      "communicator":"winrm",
      "winrm_use_ssl": "true",
      "winrm_insecure": "true",
      "winrm_timeout": "4h",
      "winrm_username": "{{user `install_user`}}",
      "winrm_password": "{{user `install_password`}}",
      "shutdown_command": "IF EXIST a:\\run-sysprep.cmd (CALL a:\\run-sysprep.cmd) ELSE (IF EXIST e:\\run-sysprep.cmd (CALL e:\\run-sysprep.cmd) ELSE (CALL f:\\run-sysprep.cmd)) &IF \"%ERRORLEVEL%\" == \"0\" (ECHO \"Shutdown script succeeded with exit code = %ERRORLEVEL%\" &EXIT 0) ELSE (ECHO \"Shutdown script failed with exit code = %ERRORLEVEL%\" &EXIT %ERRORLEVEL%)",
      "ram_size": "{{user `ram_size`}}",
      "cpu": "{{user `cpu`}}",
      "generation": 2,
      "switch_name":"{{user `hyperv_switchname`}}",
      "enable_secure_boot":true
    }],"provisioners": [
        {
            "type": "powershell",
            "inline":[
                "Get-Disk |",
                "Where partitionstyle -eq 'raw' |",
                "Initialize-Disk -PartitionStyle MBR -PassThru |",
                "New-Partition -AssignDriveLetter -UseMaximumSize |",
                "Format-Volume -FileSystem NTFS -NewFileSystemLabel 'Source' -Confirm:$false"
            ]
        },
      {
          "type": "powershell",
          "inline":[
              "New-Item -Path {{user `image_folder`}} -ItemType Directory -Force",
              "Write-Output {{user `commit_id`}} > {{user `commit_file`}}",
              "Write-Host (Get-Content -Path {{user `commit_file`}})"
          ]
      },
      {
          "type": "file",
          "source": "{{ template_dir }}/scripts/ImageHelpers",
          "destination": "{{user `helper_script_folder`}}"
      },
      {
          "type": "windows-shell",
          "inline": [
              "net user {{user `install_user`}} {{user `install_password`}} /add /passwordchg:no /passwordreq:yes /active:yes /Y" ,
              "net localgroup Administrators {{user `install_user`}} /add",
              "winrm quickconfig -q",
              "winrm quickconfig '-transport:http'",
              "winrm set \"winrm/config\" '@{MaxTimeoutms=\"1800000\"}'",
              "winrm set \"winrm/config/winrs\" '@{MaxMemoryPerShellMB=\"512\"}'",
              "winrm set \"winrm/config/service\" '@{AllowUnencrypted=\"true\"}'",
              "winrm set \"winrm/config/client\" '@{AllowUnencrypted=\"true\"}'",
              "winrm set \"winrm/config/service/auth\" '@{Basic=\"true\"}'",
              "winrm set \"winrm/config/client/auth\" '@{Basic=\"true\"}'",
              "winrm set \"winrm/config/service/auth\" '@{Basic=\"true\"}'",
              "winrm set \"winrm/config/listener?Address=*+Transport=HTTP\" '@{Port=\"5985\"}'",
              "netsh advfirewall firewall set rule group=\"remote administration\" new enable=yes",
              "netsh firewall add portopening TCP 5985 \"Port 5985\"",
              "net stop winrm",
              "sc config winrm start= auto",
              "net start winrm",
              "wmic useraccount where \"name='{{user `install_user`}}'\" set PasswordExpires=FALSE"
		  ]
      },
      {
          "type": "powershell",
          "inline": [
              "if (-not ((net localgroup Administrators) -contains '{{user `install_user`}}')) { exit 1 }"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Vs2017/Initialize-VM.ps1"
          ]
      },
      {
          "type": "windows-restart",
          "restart_timeout": "30m"
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Vs2017/Install-ContainersFeature.ps1"
          ]
      },
      {
          "type": "windows-restart",
          "restart_timeout": "30m"
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Vs2017/Install-Docker.ps1"
          ]
      },
      {
          "type": "windows-restart",
          "restart_timeout": "30m"
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Vs2017/Validate-Docker.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Vs2017/Update-DockerImages.ps1"
          ]
      },
      {
          "type": "powershell",
          "valid_exit_codes": [
              0,
              3010
          ],
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Vs2017/Install-VS2017.ps1"
          ],
          "elevated_user": "{{user `install_user`}}",
          "elevated_password": "{{user `install_password`}}"
      },
      {
          "type": "windows-restart",
          "restart_timeout": "30m"
      },
      {
          "type": "powershell",
          "valid_exit_codes": [
              0,
              3010
          ],
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Vs2017/Install-SSDT.ps1"
          ],
          "elevated_user": "{{user `install_user`}}",
          "elevated_password": "{{user `install_password`}}"
      },
      {
          "type": "windows-restart",
          "restart_timeout": "30m"
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Vs2017/Install-Wix.ps1"
          ]
      },
      {
          "type": "powershell",
          "valid_exit_codes": [
              0,
              3010
          ],
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-NET472.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-ServiceFabricSDK.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Vs2017/Install-Python.ps1"
          ]
      },
      {
          "type": "windows-restart",
          "restart_timeout": "30m"
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Vs2017/Validate-SSDT.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Vs2017/Validate-Wix.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-NET472.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-ServiceFabricSDK.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-Python.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-AzureCli.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Download-ToolCache.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-Git.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-Go.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-Ruby.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-Svn.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-Chrome.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-Firefox.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
                "{{ template_dir }}/scripts/Installers/Install-SeleniumWebDrivers.ps1"
            ]
        },
        {
            "type": "powershell",
            "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-NodeLts.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-JavaTools.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-Cmake.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-DACFx.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Update-AndroidSDK.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-MysqlCli.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-SQLPowerShellTools.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-DotnetSDK.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-WindowsUpdates.ps1"
          ]
      },
      {
          "type": "windows-shell",
          "inline": ["wmic product where \"name like '%%microsoft azure powershell%%'\" call uninstall /nointeractive"]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Install-AzureModules.ps1"
          ]
      },
      {
            "type": "powershell",
            "scripts":[
                "{{ template_dir }}/scripts/Installers/Update-DotnetTLS.ps1"
            ]
        },
        {
            "type": "powershell",
            "scripts":[
                "{{ template_dir }}/scripts/Installers/Install-MinGW.ps1"
            ]
        },
        {
            "type": "powershell",
            "scripts":[
                "{{ template_dir }}/scripts/Installers/Install-TypeScript.ps1"
            ]
        },
        {
            "type": "powershell",
            "scripts":[
                "{{ template_dir }}/scripts/Installers/Install-Miniconda.ps1"
            ]
        },
        {
            "type": "powershell",
            "scripts":[
                "{{ template_dir }}/scripts/Installers/Install-AzureCosmosDbEmulator.ps1"
            ]
        },
        {
          "type": "windows-restart",
          "restart_timeout": "30m"
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-AzureModules.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-AzureCli.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
                "{{ template_dir }}/scripts/Installers/Validate-ToolCache.ps1"
            ]
        },
        {
            "type": "powershell",
            "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-Git.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-Go.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
                "{{ template_dir }}/scripts/Installers/Validate-Ruby.ps1"
            ]
        },
        {
            "type": "powershell",
            "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-Svn.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-Chrome.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-Firefox.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
                "{{ template_dir }}/scripts/Installers/Validate-SeleniumWebDrivers.ps1"
            ]
        },
        {
            "type": "powershell",
            "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-NodeLts.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-JavaTools.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-Cmake.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-DACFx.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-DotnetSDK.ps1"
          ]
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Validate-MysqlCli.ps1"
          ]
      },
      {
            "type": "powershell",
            "scripts":[
                "{{ template_dir }}/scripts/Installers/Validate-DotnetTLS.ps1"
            ]
        },
        {
            "type": "powershell",
            "scripts":[
                "{{ template_dir }}/scripts/Installers/Validate-MinGW.ps1"
            ]
        },
        {
            "type": "powershell",
            "scripts":[
                "{{ template_dir }}/scripts/Installers/Validate-TypeScript.ps1"
            ]
        },
        {
            "type": "powershell",
            "scripts":[
                "{{ template_dir }}/scripts/Installers/Validate-Miniconda.ps1"
            ]
        },
        {
            "type": "powershell",
            "scripts":[
                "{{ template_dir }}/scripts/Installers/Validate-AzureCosmosDbEmulator.ps1"
            ]
        },
        {
          "type": "file",
          "source": "C:\\InstalledSoftware.md",
          "destination": "{{ template_dir }}/InstalledSoftware.md",
          "direction": "download"
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Finalize-VM.ps1"
          ]
      },
      {
          "type": "windows-restart",
          "restart_timeout": "30m"
      },
      {
          "type": "powershell",
          "scripts":[
              "{{ template_dir }}/scripts/Installers/Vs2017/Run-Antivirus.ps1"
          ]
        },
        {
            "type": "powershell",
            "inline": [
                "if( Test-Path $Env:SystemRoot\\System32\\Sysprep\\unattend.xml ){ rm $Env:SystemRoot\\System32\\Sysprep\\unattend.xml -Force}",
                "& $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit",
                "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Write-Output $imageState.ImageState; Start-Sleep -s 10  } else { break } }"
            ]
      }
  ]
}